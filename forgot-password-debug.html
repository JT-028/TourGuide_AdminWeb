<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Debug Mode</title>
    <link rel="icon" type="image/svg+xml" href="web_icon/web_icon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <style>
        .debug-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        .debug-log {
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            background: #212529;
            color: #fff;
            padding: 12px;
            border-radius: 4px;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white text-center">
                <i data-feather="key" class="w-16 h-16 mx-auto mb-4"></i>
                <h1 class="text-2xl font-bold">Forgot Password</h1>
                <p class="text-blue-100 mt-2">Debug Mode - Step by Step</p>
            </div>
            
            <div class="p-6">
                <form id="forgotPasswordForm" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                            Email Address
                        </label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Enter your email address">
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                        Send Reset Link
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <a href="login.html" class="text-sm text-blue-600 hover:text-blue-800">
                        ← Back to Login
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Debug Panel -->
        <div class="debug-container">
            <h3 class="text-lg font-semibold mb-3">Debug Information</h3>
            <div class="space-y-3">
                <div>
                    <strong>Firebase Status:</strong>
                    <span id="firebase-status" class="ml-2">
                        <span class="status-indicator status-info"></span>
                        Checking...
                    </span>
                </div>
                <div>
                    <strong>Email Service:</strong>
                    <span id="email-status" class="ml-2">
                        <span class="status-indicator status-warning"></span>
                        Not tested
                    </span>
                </div>
                <div>
                    <strong>Last Action:</strong>
                    <span id="last-action" class="ml-2 text-sm text-gray-600">Waiting for user input</span>
                </div>
            </div>
            
            <div class="mt-4">
                <strong>Debug Log:</strong>
                <div id="debug-log" class="debug-log mt-2">
                    [System] Debug mode initialized<br>
                </div>
            </div>
            
            <div class="mt-4 flex gap-2">
                <button onclick="clearDebugLog()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                    Clear Log
                </button>
                <button onclick="testFirebaseConnection()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                    Test Connection
                </button>
                <button onclick="checkEmailConfiguration()" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                    Check Email Config
                </button>
            </div>
        </div>
    </div>

    <script>
        let debugLog = [];
        
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            
            const logDiv = document.getElementById('debug-log');
            const statusClass = `status-${type}`;
            logDiv.innerHTML += `<span class="${statusClass}">●</span> ${logEntry}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Update last action
            document.getElementById('last-action').textContent = message;
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusClass = `status-${status}`;
            element.innerHTML = `<span class="status-indicator ${statusClass}"></span>${message}`;
        }
        
        function clearDebugLog() {
            debugLog = [];
            document.getElementById('debug-log').innerHTML = '[System] Debug log cleared<br>';
        }
        
        async function testFirebaseConnection() {
            addDebugLog('Testing Firebase connection...', 'info');
            
            try {
                // Test 1: Check Firebase SDK
                if (typeof firebase === 'undefined') {
                    addDebugLog('ERROR: Firebase SDK not loaded', 'error');
                    updateStatus('firebase-status', 'error', 'Firebase SDK not loaded');
                    return;
                }
                addDebugLog('✓ Firebase SDK loaded', 'success');
                
                // Test 2: Check Firebase app
                if (!firebase.app) {
                    addDebugLog('ERROR: Firebase app not initialized', 'error');
                    updateStatus('firebase-status', 'error', 'App not initialized');
                    return;
                }
                addDebugLog('✓ Firebase app initialized', 'success');
                
                // Test 3: Check Firebase Auth
                if (!firebase.auth) {
                    addDebugLog('ERROR: Firebase Auth not available', 'error');
                    updateStatus('firebase-status', 'error', 'Auth not available');
                    return;
                }
                addDebugLog('✓ Firebase Auth available', 'success');
                
                // Test 4: Check firebaseServices
                if (typeof firebaseServices === 'undefined') {
                    addDebugLog('ERROR: firebaseServices not defined', 'error');
                    updateStatus('firebase-status', 'error', 'Services not defined');
                    return;
                }
                addDebugLog('✓ firebaseServices defined', 'success');
                
                // Test 5: Check auth service
                if (!firebaseServices.auth) {
                    addDebugLog('ERROR: firebaseServices.auth not available', 'error');
                    updateStatus('firebase-status', 'error', 'Auth service missing');
                    return;
                }
                addDebugLog('✓ firebaseServices.auth available', 'success');
                
                updateStatus('firebase-status', 'success', 'All services working');
                addDebugLog('Firebase connection test completed successfully', 'success');
                
            } catch (error) {
                addDebugLog(`Firebase test error: ${error.message}`, 'error');
                updateStatus('firebase-status', 'error', 'Test failed');
            }
        }
        
        function checkEmailConfiguration() {
            addDebugLog('Checking email configuration...', 'info');
            
            // Check if we're in a local environment
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (isLocalhost) {
                addDebugLog('WARNING: Running on localhost - this may cause issues', 'warning');
            }
            
            // Check current domain
            const currentDomain = window.location.origin;
            addDebugLog(`Current domain: ${currentDomain}`, 'info');
            
            // Check if Firebase is properly configured
            if (typeof firebaseServices !== 'undefined' && firebaseServices.auth) {
                addDebugLog('✓ Firebase Auth is configured', 'success');
                updateStatus('email-status', 'success', 'Service configured');
            } else {
                addDebugLog('✗ Firebase Auth not properly configured', 'error');
                updateStatus('email-status', 'error', 'Service not configured');
            }
        }
        
        // Main form submission handler
        document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            addDebugLog(`Starting password reset for: ${email}`, 'info');
            
            submitBtn.innerHTML = '<i data-feather="loader" class="w-4 h-4 mr-2 animate-spin"></i>Sending...';
            submitBtn.disabled = true;
            
            try {
                // Step 1: Validate email
                addDebugLog('Validating email format...', 'info');
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    throw new Error('Invalid email format');
                }
                addDebugLog('✓ Email format valid', 'success');
                
                // Step 2: Check Firebase services
                addDebugLog('Checking Firebase services...', 'info');
                if (typeof firebaseServices === 'undefined' || !firebaseServices.auth) {
                    throw new Error('Firebase services not available');
                }
                addDebugLog('✓ Firebase services available', 'success');
                
                // Step 3: Attempt to send reset email
                addDebugLog('Sending password reset email...', 'info');
                
                // Try with action code settings first
                const actionCodeSettings = {
                    url: window.location.origin + '/login.html',
                    handleCodeInApp: false
                };
                
                addDebugLog(`Action URL: ${actionCodeSettings.url}`, 'info');
                
                try {
                    await firebaseServices.auth.sendPasswordResetEmail(email, actionCodeSettings);
                    addDebugLog('✓ Reset email sent with action settings', 'success');
                } catch (settingsError) {
                    addDebugLog(`Failed with settings: ${settingsError.code}`, 'warning');
                    addDebugLog('Trying without action settings...', 'info');
                    
                    // Fallback: try without action code settings
                    await firebaseServices.auth.sendPasswordResetEmail(email);
                    addDebugLog('✓ Reset email sent without settings', 'success');
                }
                
                // Success
                submitBtn.innerHTML = '<i data-feather="check" class="w-4 h-4 mr-2"></i>Sent!';
                updateStatus('email-status', 'success', 'Email sent successfully');
                
                Swal.fire({
                    title: 'Reset Link Sent!',
                    text: 'Check your inbox and follow the instructions to reset your password.',
                    icon: 'success',
                    confirmButtonColor: '#10b981'
                });
                
                this.reset();
                addDebugLog('Password reset process completed successfully', 'success');
                
            } catch (error) {
                console.error('Password reset error:', error);
                addDebugLog(`ERROR: ${error.code || 'UNKNOWN'} - ${error.message}`, 'error');
                
                let message = error.message || 'Failed to send reset email';
                if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address';
                } else if (error.code === 'auth/user-not-found') {
                    message = 'No user found with this email';
                } else if (error.code === 'auth/too-many-requests') {
                    message = 'Too many attempts. Please try again later.';
                } else if (error.code === 'auth/network-request-failed') {
                    message = 'Network error. Check your connection.';
                } else if (error.code === 'auth/internal-error') {
                    message = 'Internal error. Email service may not be configured.';
                } else if (error.code === 'auth/configuration-not-found') {
                    message = 'Email service not configured in Firebase Console.';
                }
                
                updateStatus('email-status', 'error', 'Failed to send email');
                
                Swal.fire({
                    title: 'Unable to Send Reset Email',
                    text: message,
                    icon: 'error',
                    confirmButtonColor: '#ef4444'
                });
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                setTimeout(() => feather.replace(), 100);
            }
        });
        
        // Initialize
        window.addEventListener('load', function() {
            feather.replace();
            addDebugLog('Forgot password page loaded in debug mode', 'info');
            testFirebaseConnection();
        });
    </script>
</body>
</html>